<%- include('../layout/user/header.ejs') -%>

    <div class="pageWrapper">
        <%-include('../partials/userNavbar')-%>



            <!--Body Content-->
            <div id="page-content">
                <!--Page Title-->
                <div class="page section-header text-center">
                    <div class="page-title">
                        <div class="wrapper">
                            <h1 class="page-width">Checkout</h1>
                        </div>
                    </div>
                </div>
                <!--End Page Title-->
                <%console.log("viewCoupons-------------------------",viewCoupons)%>
                    <div class="container">
                        <div class="row">
                            <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12 mb-3">
                                <div class="customer-box returning-customer">
                                    <h3><i class="icon anm anm-user-al"></i> Do want add new address? <a
                                            href="#addAddress" id="customer"
                                            class="text-white text-decoration-underline" data-toggle="collapse">Add New
                                            address</a></h3>
                                    <!-- <h3><i class="icon anm anm-user-al"></i> Do want add new address? <a href="#customer-login" id="customer" class="text-white text-decoration-underline" data-toggle="collapse">Add New address</a></h3> -->
                                    <div id="addAddress"
                                        class="create-ac-content bg-light-gray padding-20px-all collapse ">
                                        <form action="/add-address" method="post"
                                            onsubmit="return addAddressValidation()">
                                            <fieldset>
                                                <h2 class="login-title mb-3">Delivery Address</h2>
                                                <div id="error-container" class="text-center text-danger"></div>
                                                <div class="row">
                                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                                        <label for="input-firstname">Full Name <span
                                                                class="required-f">*</span></label>
                                                        <input name="name" value="" id="input-firstname" type="text">
                                                    </div>
                                                    <!-- <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                            <label for="input-lastname">Last Name <span class="required-f">*</span></label>
                                            <input name="lastname" value="" id="input-lastname" type="text">
                                        </div> -->
                                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                                        <label for="input-telephone">Mobile <span
                                                                class="required-f">*</span></label>
                                                        <input name="mobile" value="" id="input-telephone" type="text">
                                                    </div>
                                                </div>

                                            </fieldset>

                                            <fieldset>
                                                <div class="row">
                                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                                        <label for="input-address-1">Address <span
                                                                class="required-f">*</span></label>
                                                        <input name="address" value="" id="input-address-1" type="text">
                                                    </div>
                                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                                        <label for="input-city">City <span
                                                                class="required-f">*</span></label>
                                                        <input name="city" value="" id="input-city" type="text">
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="form-group col-md-6 col-lg-6 col-xl-6">
                                                        <label for="input-district">District <span
                                                                class="required-f">*</span></label>
                                                        <input name="district" value="" id="input-district" type="text">
                                                    </div>
                                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                                        <label for="input-zone">State <span
                                                                class="required-f">*</span></label>
                                                        <select name="state" id="input-zone">
                                                            <option value="Andhra Pradesh">Andhra Pradesh</option>
                                                            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                                                            <option value="Assam">Assam</option>
                                                            <option value="Bihar">Bihar</option>
                                                            <option value="Chhattisgarh">Chhattisgarh</option>
                                                            <option value="Goa">Goa</option>
                                                            <option value="Gujarat">Gujarat</option>
                                                            <option value="Haryana">Haryana</option>
                                                            <option value="Himachal Pradesh">Himachal Pradesh</option>
                                                            <option value="Jharkhand">Jharkhand</option>
                                                            <option value="Karnataka">Karnataka</option>
                                                            <option value="Kerala" selected>Kerala</option>
                                                            <option value="Madhya Pradesh">Madhya Pradesh</option>
                                                            <option value="Maharashtra">Maharashtra</option>
                                                            <option value="Manipur">Manipur</option>
                                                            <option value="Meghalaya">Meghalaya</option>
                                                            <option value="Mizoram">Mizoram</option>
                                                            <option value="Nagaland">Nagaland</option>
                                                            <option value="Odisha">Odisha</option>
                                                            <option value="Punjab">Punjab</option>
                                                            <option value="Rajasthan">Rajasthan</option>
                                                            <option value="Sikkim">Sikkim</option>
                                                            <option value="Tamil Nadu">Tamil Nadu</option>
                                                            <option value="Telangana">Telangana</option>
                                                            <option value="Tripura">Tripura</option>
                                                            <option value="Uttar Pradesh">Uttar Pradesh</option>
                                                            <option value="Uttarakhand">Uttarakhand</option>
                                                            <option value="West Bengal">West Bengal</option>
                                                            <option value="Andaman and Nicobar Islands">Andaman and
                                                                Nicobar
                                                                Islands</option>
                                                            <option value="Chandigarh">Chandigarh</option>
                                                            <option value="Dadra and Nagar Haveli">Dadra and Nagar
                                                                Haveli
                                                            </option>
                                                            <option value="Daman and Diu">Daman and Diu</option>
                                                            <option value="Lakshadweep">Lakshadweep</option>
                                                            <option value="Delhi">Delhi</option>
                                                            <option value="Puducherry">Puducherry</option>
                                                        </select>

                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                                        <label for="input-postcode">Post Code <span
                                                                class="required-f">*</span></label>
                                                        <input name="pincode" value="" id="input-postcode" type="text">
                                                    </div>
                                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                                        <label for="input-country">Country <span
                                                                class="required-f">*</span></label>
                                                        <select name="country" id="input-country">
                                                            <option value="India" selected>India</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </fieldset>


                                            <fieldset>
                                                <div class="row d-flex justify-content-center">
                                                    <button type="submit" class="btn">submit</button>
                                                </div>
                                            </fieldset>
                                        </form>
                                    </div>

                                </div>
                            </div>

                            <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12 mb-3">
                                <div class="customer-box customer-coupon">
                                    <h3 class="font-15 xs-font-13"><i class="icon anm anm-gift-l"></i> Have a coupon? <a
                                            href="#have-coupon" class="text-white text-decoration-underline"
                                            data-toggle="collapse">Click here to enter your code</a></h3>
                                    <div id="have-coupon" class="collapse coupon-checkout-content">
                                        <div class="discount-coupon">
                                            <div id="coupon" class="coupon-dec tab-pane active">
                                                <p class="margin-10px-bottom">Enter your coupon code if you have one.
                                                </p>
                                                <label class="required get" for="coupon-code"><span
                                                        class="required-f">*</span>
                                                    Coupon</label>

                                                <% if(cartData?.couponApplied){ %>
                                                    <input id="coupon-code" required="" type="text" class="mb-3"
                                                        disabled>
                                                    <% } else { %>
                                                        <input id="coupon-code" required="" type="text" class="mb-3 ">
                                                        <% } %>

                                                            <button class="coupon-btn btn" type="button"
                                                                id="apply-coupon">Apply
                                                                Coupon</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row billing-fields">
                            <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12 sm-margin-30px-bottom">
                                <!-- <div class="create-ac-content bg-light-gray padding-20px-all">
                        <form>
                            <fieldset>
                                <h2 class="login-title mb-3">Billing details</h2>
                                <div class="row">
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                        <label for="input-firstname">First Name <span class="required-f">*</span></label>
                                        <input name="firstname" value="" id="input-firstname" type="text">
                                    </div>
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                        <label for="input-lastname">Last Name <span class="required-f">*</span></label>
                                        <input name="lastname" value="" id="input-lastname" type="text">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                        <label for="input-email">E-Mail <span class="required-f">*</span></label>
                                        <input name="email" value="" id="input-email" type="email">
                                    </div>
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                        <label for="input-telephone">Telephone <span class="required-f">*</span></label>
                                        <input name="telephone" value="" id="input-telephone" type="tel">
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset>
                                <div class="row">
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6">
                                        <label for="input-company">Company</label>
                                        <input name="company" value="" id="input-company" type="text">
                                    </div>
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                        <label for="input-address-1">Address <span class="required-f">*</span></label>
                                        <input name="address_1" value="" id="input-address-1" type="text">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6">
                                        <label for="input-address-2">Apartment <span class="required-f">*</span></label>
                                        <input name="address_2" value="" id="input-address-2" type="text">
                                    </div>
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                        <label for="input-city">City <span class="required-f">*</span></label>
                                        <input name="city" value="" id="input-city" type="text">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                        <label for="input-postcode">Post Code <span class="required-f">*</span></label>
                                        <input name="postcode" value="" id="input-postcode" type="text">
                                    </div>
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                        <label for="input-country">Country <span class="required-f">*</span></label>
                                        <select name="country_id" id="input-country">
                                            <option value=""> --- Please Select --- </option>
                                            <option value="244">Aaland Islands</option>
                                            <option value="1">Afghanistan</option>
                                            <option value="2">Albania</option>
                                            <option value="3">Algeria</option>
                                            <option value="4">American Samoa</option>
                                            <option value="5">Andorra</option>
                                            <option value="6">Angola</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="form-group col-md-6 col-lg-6 col-xl-6 required">
                                        <label for="input-zone">Region / State <span class="required-f">*</span></label>
                                        <select name="zone_id" id="input-zone">
                                            <option value=""> --- Please Select --- </option>
                                            <option value="3513">Aberdeen</option>
                                            <option value="3514">Aberdeenshire</option>
                                            <option value="3515">Anglesey</option>
                                            <option value="3516">Angus</option>
                                        </select>
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset>
                                <div class="row">
                                    <div class="form-group form-check col-md-12 col-lg-12 col-xl-12">
                                        <label class="form-check-label padding-15px-left">
                                            <input type="checkbox" class="form-check-input" value=""><strong>Create an account ?</strong>
                                        </label>
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset>
                                <div class="row">
                                    <div class="form-group col-md-12 col-lg-12 col-xl-12">
                                        <label for="input-company">Order Notes <span class="required-f">*</span></label>
                                        <textarea class="form-control resize-both" rows="3"></textarea>
                                    </div>
                                </div>
                            </fieldset>
                        </form>
                    </div> -->
                                <div class="d-flex justify-content-between">
                                    <div class="text-left pl-2">
                                        <% if (userData){%>
                                            <%if(userData.addresses.length>0){%>
                                                <h3>Choose a delivery address </h3>
                                                <%}else{%>
                                                    <h3>Please add delivery address </h3>
                                                    <%}%>
                                    </div>
                                    <div class="text-right pr-2 pb-1">
                                        <!-- <button class="bg-dark rounded-pill "><h3 class="text-white pt-1  ">view coupons</h3></button> -->
                                        <!-- Button to trigger the modal -->

                                        <% if(cartData?.couponApplied){%>

                                            <button class="btn btn-dark rounded-pill" id="coupon-remove-button">
                                                remove coupon
                                            </button>

                                            <% }else{ %>

                                                <button class="btn btn-dark rounded-pill" id="cancel-button"
                                                    data-orderId="" data-toggle="modal" data-target="#customizedModal">
                                                    view coupons
                                                </button>
                                                <% } %>





                                    </div>
                                </div>
                                <div id='addressError' class="text-danger"></div>

                                <% userData.addresses.forEach((address, index)=>{%>
                                    <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
                                        <span> <input type="radio" <%=index==0?"checked":null%> id="address-<%= index %>
                                                "
                                                name="selectedAddress"
                                                value="<%= index %>">
                                                    <label for="address-<%= index %>"></label></span>
                                        <h3>
                                            <%= address.name %>
                                        </h3>
                                        <p>
                                            <%= address.address %>,<%= address.place %>
                                                    <br>
                                                    <%= address.city %>
                                                        <%= address.district %>
                                                            <br>
                                                            <%= address.state %>
                                                                <%= address.country %>
                                                                    <br>
                                                                    <%= address.mobile %> <br>

                                        </p>


                                        <!-- Add radio button for each address -->
                                    </div>
                                    <%})%>
                                        <%}%>

                                            <!-- <a href="/add-address" class="btn"></a> -->

                            </div>

                            <% if(cartData){%>
                                <% console.log('cartData from checkout ejs====',cartData)%>
                           
                                <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12">
                                    <!-- <div class="ml-2 d-none"  id="coupon-remove-button">
                                        <button class="btn btn-dark rounded-pill">remove coupon</button>
                                    </div> -->
                                    <div class="your-order-payment">
                                        <div class="your-order">
                                            <h2 class="order-title mb-4" id="order" cartId="<%=cartData._id%>">Your Order
                                            </h2>

                                            <div class="table-responsive-sm order-table">

                                                <table class="bg-white table table-bordered table-hover text-center">
                                                    <thead>
                                                        <tr>
                                                            <th class="text-left">Product Name</th>
                                                            <th>Price</th>
                                                            <!-- <th>Size</th> -->
                                                            <th>Qty</th>
                                                            <th>Amount</th>
                                                        </tr>
                                                    </thead>
                                                    <% let subtotal=0 %>
                                                        <% cartData.products.forEach((product,index)=>{%>
                                                            <tbody>

                                                                <tr>
                                                                    <td class="text-left">
                                                                        <%= product.productId.name %>
                                                                    </td>
                                                                    <td>₹ <%= product.offerPrice%>.00</td>

                                                                    <td>
                                                                        <%= product.quantity %>
                                                                    </td>
                                                                    <td>₹ <%= product.offerPrice * product.quantity %>.00
                                                                    </td>
                                                                </tr>

                                                                <% subtotal+=product.offerPrice * product.quantity %>
                                                            </tbody>
                                                            <% })%>
                                                                <tfoot class="font-weight-600">
                                                                    <tr>
                                                                        <td colspan="3" class="text-right">Shipping
                                                                        </td>
                                                                        <td>₹ 0.00</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td colspan="3" class="text-right">Subtotal
                                                                        </td>
                                                                        <td>₹ <%= subtotal%>.00</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td colspan="3" class="text-right">Coupon Discount
                                                                        </td>
                                                                        <td id="discountId">₹ <%= cartData?.coupon?.couponDiscount ? cartData?.coupon?.couponDiscount :0 %>.00</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <%let totalAmount%>
                                                                        <%if(cartData?.coupon?.couponDiscount){%>
                                                                            <% totalAmount = subtotal-cartData?.coupon?.couponDiscount%>
                                                                            <%}else{%>
                                                                                 <% totalAmount = subtotal%>
                                                                            <%}%>

                                                                        <td colspan="3" class="text-right font-weight-bold fs-5">Total</td>
                                                                        <td id="sub-total" class="font-weight-bold fs-5"
                                                                            data-subtotal="<%= totalAmount%>">₹
                                                                            <%= totalAmount %>.00
                                                                        </td>
                                                                    </tr>
                                                                </tfoot>
                                                </table>

                                            </div>
                                        </div>

                                        <hr />

                                        <div class="your-payment">
                                            <h2 class="payment-title mb-3">payment method</h2>
                                            <div class="payment-method">
                                                <div class="payment-accordion">
                                                    <div id="accordion" class="payment-section">
                                                        <div id=' paymentError' class="text-danger">
                        </div>
<%if(totalAmount>=1000){%>
                        <div class="card mb-2">
                            <div class="card-header d-flex ">
                                <input class="mr-2" type="radio" name="paymentOption" id="cashOnDelivery" value="COD">
                                <label class="card-link" for="cashOnDelivery">Cash on
                                    Delivery</label>
                            </div>
                        </div>
                        <%}%>

                        <div class="card mb-2">
                            <div class="card-header d-flex ">
                                <input class="mr-2" type="radio" name="paymentOption" value="Online"
                                    id="Online_Payment">
                                <label class="card-link" for="Online">Online
                                    Payment</label>
                            </div>
                        </div>

                        <div class="card mb-2">
                            <div class="card-header d-flex ">
                                <input class="mr-2" type="radio" name="paymentOption" value="Wallet" id="wallet">
                                <label class="card-link" for="Wallet">Wallet(₹ <%=wallet?.balance%>.00)</label>
                            </div>
                        </div>

                    </div>
            </div>
            <div class="order-button-payment">
                <button class="btn" value="Place order" id="place-order" type="submit"
                    onclick="checkoutValidation()">Place
                    order</button>
            </div>
    </div>
    </div>
    </div>
    </div>
    <%}%>
        </div>
        </div>
        </div>
        <!--End Body Content-->

        <div class="modal fade" id="customizedModal" tabindex="-1" role="dialog" aria-labelledby="customizedModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered  modal-dialog-scrollable" style="max-width: 500px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Available Coupons</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" style="height: 350px; overflow: auto;">
                        <div class="form-group">
                            <table class="table" id="myTable">
                                <thead>
                                    <tr>
                                        <th class="mx-2 text-dark font-weight-bold fs-5">Name</th>
                                        <th class="mx-2 text-dark font-weight-bold fs-5">Offer</th>
                                        <th class="mx-2 text-dark font-weight-bold fs-5">Valid upto
                                        </th>
                                        <th class="mx-2 text-dark font-weight-bold fs-5">Min Order
                                        </th>
                                        <th class="mx-2 text-dark font-weight-bold fs-5">Coupon code
                                        </th>
                                    </tr>
                                </thead>

                                <tbody>
                                    <%if(Array.isArray(viewCoupons) && viewCoupons.length> 0){%>
                                        <%viewCoupons.forEach( coupon=> { %>
                                            <%console.log("coupon-------------------------------",coupon)%>

                                                <tr>
                                                    <td class="text-center m-2">
                                                        <%=coupon.title%>
                                                    </td>
                                                    <td class=" text-center m-2"><span class="text-success"> Offer :
                                                            <%=coupon.discount%> %
                                                        </span></td>
                                                    <% const formattedDate=coupon.expiryDate.toLocaleString('en-US', {
                                                        month: 'short' , day: 'numeric' , year: 'numeric' }); %>

                                                        <td class="text-center m-2">
                                                            <%=formattedDate%>
                                                        </td>
                                                        <td class="text-center m-2"> ₹
                                                            <%=coupon.minCost%>
                                                        </td>
                                                        <td class="text-center  m-2">
                                                            <div class="coupon-container">
                                                                <span style="font-size: 12px;">click to
                                                                    copy</span>
                                                                <div class="p-1 rounded-pill btn "
                                                                    style="background-color: rgb(117, 117, 117);">
                                                                    <div class="coupon-code  fs-5"
                                                                        style="color: rgb(255, 255, 255); font-weight: 400; cursor: pointer;">
                                                                        <%=coupon.couponCode%>
                                                                    </div>
                                                                </div>
                                                                <!-- <div class="copy-message text-primary " id="copyMessage">
                                                                Coupon code copied!
                                                            </div> -->
                                                            </div>

                                                        </td>
                                                </tr>

                                                <%})%>
                                                    <%}else{%>
                                                        <tr>
                                                            <td class="text-center " colspan="5">
                                                                <p class="font-weight-bold">No coupns available</p>

                                                            </td>
                                                        </tr>
                                                        <%}%>
                                                            <!-- Add more rows as needed -->
                                </tbody>
                            </table>

                            <!-- <%if (viewCoupons.length>0){%>
                                    <%viewCoupons.forEach((coupon, i)=>{%>
                                        <% console.log("coupon ejs---------------------------------",coupon)%>

                                    <div class="d-flex">

                                        <%=coupon.title%>
                                        <%=coupon.couponCode%>
                                        <%=coupon.discount%>
                                    </div>
                                    <%})%>
                                    <%}else{%>
                                        <p>No Available Coupon</p>
                                    <%}%> -->

                        </div>

                    </div>

                    <div class="modal-footer" style="justify-content: space-around;">
                        <!-- <button type="button" id="cancel-confirm" class="btn btn-primary ">Confirm</button> -->
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>



        <!--Footer-->

        <!--End Footer-->
        <!--Scoll Top-->
        <span id="site-scroll"><i class="icon anm anm-angle-up-r"></i></span>
        <!--End Scoll Top-->

        <script>

            function addAddressValidation() {
                // event.preventDefault(); // Prevent form submission if validation fails
                console.log('im add-address validation');
                // Get form fields
                const name = document.getElementById('input-firstname').value.trim();
                const mobile = document.getElementById('input-telephone').value.trim();
                const address = document.getElementById('input-address-1').value.trim();
                const district = document.getElementById('input-district').value.trim();
                const city = document.getElementById('input-city').value.trim();
                const pincode = document.getElementById('input-postcode').value.trim();

                // Regular expressions for validation
                const nameRegex = /^[^\s].+/;
                const mobileRegex = /^\d{10}$/;
                const textRegex = /^[^\d]+$/;
                const pincodeRegex = /^\d{6}$/;

                // Error messages
                const errors = [];

                // Validate each field
                if (!nameRegex.test(name) || name == '') {
                    errors.push('Please enter a proper name');
                    document.getElementById('input-firstname').classList.add('error');
                    displayErrors(errors);
                    return false;
                }

                if (!mobileRegex.test(mobile) || mobile.length > 10 || mobile.length < 10) {
                    errors.push('Mobile number should be 10 digits.');
                    document.getElementById('input-telephone').classList.add('error');
                    displayErrors(errors);
                    return false;
                }

                if (!textRegex.test(address) || address == '') {
                    errors.push('Please enter a valid address');
                    document.getElementById('input-address-1').classList.add('error');
                    displayErrors(errors);
                    return false;
                }

                if (!textRegex.test(district) || district == '') {
                    errors.push('Please enter a valid distric name.');
                    document.getElementById('input-district').classList.add('error');
                    displayErrors(errors);
                    return false;
                }

                if (!textRegex.test(city) || city == '') {
                    errors.push('Please enter a valid city name.');
                    document.getElementById('input-city').classList.add('error');
                    displayErrors(errors);
                    return false;
                }

                if (!pincodeRegex.test(pincode) || pincode == '') {
                    errors.push('Pincode should be 6 digits.');
                    document.getElementById('input-postcode').classList.add('error');
                    displayErrors(errors);
                    return false;
                }

                // If all validations pass, return true
                console.log('return true');
                return true;
            }

            function displayErrors(errors) {
                // Display error messages
                const errorContainer = document.getElementById('error-container');
                errorContainer.innerHTML = errors.map(error => `<strong><p class="text-danger">${error}</p></strong>`).join('');
                errorContainer.style.display = 'block';
                setTimeout(() => {
                    errorContainer.innerHTML = ""
                }, 3000)
            }

            // Remove error class on input focus
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('focus', () => {
                    input.classList.remove('error');
                    document.getElementById('error-container').style.display = '';
                });
            });
        </script>


        <script>
            function checkoutValidation(event) {

                // let placeOrderButton =event.target;
                // couponCode= placeOrderButton.getAttribute('coupon-code')
                // console.log("coupon-code",couponCode)//------------------------------------

                console.log('im addres payment validation');//-----------------
                const addressRadios = document.getElementsByName('selectedAddress');
                const paymentError = document.getElementById('paymentError');
                const addressError = document.getElementById('addressError');
                const paymentOption = document.getElementsByName('paymentOption');


                let addressSelected = false;
                for (let i = 0; i < addressRadios.length; i++) {
                    if (addressRadios[i].checked) {
                        addressSelected = true;
                        break;
                    }
                }

                let paymentSelected = false;
                for (let i = 0; i < paymentOption.length; i++) {
                    if (paymentOption[i].checked) {
                        paymentSelected = true;
                    }
                }

                if (!addressSelected) {
                    Swal.fire({
                        icon: 'warning',
                        text: " please Select Delivery Address !",
                        showConfirmButton: false,
                        width: '300px',
                        showConfirmButton: '#d33'
                    })
                    return false;

                } else if (!paymentSelected) {
                    Swal.fire({
                        icon: 'warning',
                        text: "Please Select Payment Method !",
                        showConfirmButton: false,
                        width: '300px',
                        showConfirmButton: '#d33'
                    })
                    return false;

                } else {
                    console.log('true is working')//----------
                    const radioButtonAddress = document.querySelector('input[name="selectedAddress"]:checked');
                    const index = radioButtonAddress ? radioButtonAddress.value : null
                    console.log('index', index)//----------
                    if (index) {
                        console.log('index1', index)//----------
                        const radioButtonPayment = document.querySelector('input[name="paymentOption"]:checked');
                        const paymentMethod = radioButtonPayment ? radioButtonPayment.value : null;
                        console.log('paymentMethod', paymentMethod)//----------
                        if (paymentMethod) {
                            console.log('paymentMethod1', paymentMethod)//----------
                            const subtotal = document.getElementById('sub-total').getAttribute('data-subtotal');
                            console.log('data-sudtotal' + subtotal)//-------------------
                            if (subtotal) {
                                console.log('subtotal', subtotal)//----------
                                let data = { index: index, subtotal: subtotal, paymentMethod: paymentMethod }

                                fetch('/place-order', {
                                    method: 'Post',
                                    headers: {
                                        'content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(data)
                                })
                                    .then(Response => Response.json())
                                    .then((res) => {
                                        console.log(res, 'res /place-order front')//-----------------------------------
                                        if (res.cartProduct == false) {

                                            Swal.fire({
                                                icon: 'warning !',
                                                text: `Sorry your cart is empty.`,
                                                width: '300px',
                                                showConfirmButton: '#d33'
                                            });
                                            setTimeout(() => {
                                                window.location.href = "/cart"
                                            }, 1500)

                                        }
if(res.notListedProduct){
    Swal.fire({
                                                icon: 'warning',
                                                text: `Sorry your product ${res.unListedProduct} Currently Un Available'`,
                                                width: '300px',
                                                showConfirmButton: '#d33'
                                            });
}

                                        if (res.quant) {
                                            Swal.fire({
                                                icon: 'warning',
                                                text: `Sorry your product ${res.lessQuantity} is Out Of Stock'`,
                                                width: '300px',
                                                showConfirmButton: '#d33'
                                            });
                                        }
                                        if (res.paymentMethod == 'COD') {
                                            location.href = `/order-success/${res.orderId}`

                                        } else if (res.paymentMethod == 'Online') {
                                            if (res.success) {
                                                console.log("ccontact", res);//----------


                                                let options = {
                                                    "key": "" + res.key_id + "", // Enter the Key ID generated from the Dashboard
                                                    "amount": res.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                                                    "currency": "INR",
                                                    "name": "ShoeFactory", //your business name
                                                    "description": "Test Transaction",
                                                    "image": "https://dummyimage.com//600x400/000/fff",
                                                    "order_id": res.order_id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                                                    handler: (response) => {

                                                        console.log("payment success", response);//---------------------
                                                        verifyRazorpayPayment(response, res);
                                                    },
                                                    "prefill": { //We recommend using the prefill parameter to auto-fill customer's contact information especially their phone number
                                                        "name": "" + res.name + "", //your customer's name
                                                        "email": "" + res.email + "",
                                                        "contact": "" + res.contact + "" //Provide the customer's phone number for better conversion rates 
                                                    },
                                                    "notes": {
                                                        "description": "" + "It is a test transaction"
                                                    },
                                                    "theme": {
                                                        "color": "#4c5d50"
                                                    }
                                                };


                                                let razorpayObject = new Razorpay(options);
                                                razorpayObject.on('payment.failed', function (response) {

                                                    console.log("annna");///-----------------------
                                                    console.log("razor failed++++++", response)//----------------------
                                                    alert("Payment failed");
                                                    handleRazorpayFailure(response, res)

                                                });

                                                razorpayObject.open();

                                            }
                                            else {
                                                console.log('im in else alert')//---------------------------
                                                alert(res.msg);
                                            }

                                        } else if (res.paymentMethod == 'Wallet') {
let subtotal;
let index;
                                            if (res.walletBalance) {

                                                Swal.fire({
                                                    icon: 'success',
                                                    text: `Wallet payment succes`,
                                                    width: '300px',
                                                    showConfirmButton: '#d33'
                                                });

                                                subtotal=res.subtotal
                                                index = res.index

                                                setTimeout(() => {
                                                    location.href = `/order-success/${res.orderId}`
                                                }, 1500)



                                            } else {
                                                if(!res.empty){
                                                    
                                                
                                                Swal.fire({
                                                    icon: 'warning',
                                                    text: `${res.message}`,
                                                    width: '300px',
                                                    showConfirmButton: true,
                                                    showCancelButton: true,
                                                    confirmButtonText: "Pay with online!",
                                                    cancelButtonText: "No!",
                                                }).then((result) => {
                                                    if (result.isConfirmed) {
                                                        // User clicked the "Pay with online!" button
                                                        console.log('User confirmed:-------------------', result);
data.paymentMethod="Wallet With Online";

console.log("data",data)//------------------------


axios.post('/place-order',data)
.then((response)=>{
response.data.success
if(response.data.success){
console.log("withi axios response", response)//--------------------------------

    if (response.data.success) {
                                                console.log("ccontact", res);//----------


                                                let options = {
                                                    "key": "" + response.data.key_id + "", // Enter the Key ID generated from the Dashboard
                                                    "amount": response.data.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                                                    "currency": "INR",
                                                    "name": "ShoeFactory", //your business name
                                                    "description": "Test Transaction",
                                                    "image": "https://dummyimage.com//600x400/000/fff",
                                                    "order_id": response.data.order_id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                                                    handler: (respon) => {

                                                        console.log("payment success", respon);//---------------------
                                                        verifyRazorpayPayment(respon, response.data);
                                                    },
                                                    "prefill": { //We recommend using the prefill parameter to auto-fill customer's contact information especially their phone number
                                                        "name": "" + response.data.name + "", //your customer's name
                                                        "email": "" + response.data.email + "",
                                                        "contact": "" + response.data.contact + "" //Provide the customer's phone number for better conversion rates 
                                                    },
                                                    "notes": {
                                                        "description": "" + "It is a test transaction"
                                                    },
                                                    "theme": {
                                                        "color": "#4c5d50"
                                                    }
                                                };


                                                let razorpayObject = new Razorpay(options);
                                                razorpayObject.on('payment.failed', function (respon) {

                                                    console.log("annna");///-----------------------
                                                    console.log("razor failed++++++", respon)//----------------------
                                                    alert("Payment failed");
                                                    handleRazorpayFailure(respon, response.data)

                                                });

                                                razorpayObject.open();

                                            }
                                            else {
                                                console.log('im in else alert')//---------------------------
                                                alert(res.msg);
                                            }

}
}).catch((error)=>{
    console.log("axios error place order",error)
})

                                                    } else if (result.dismiss === Swal.DismissReason.cancel) {
                                                        console.log('User cancelled:', result);
                                                    }
                                                });
                                            }else{
                                                Swal.fire({
                                                    icon: 'error',
                                                    text: `${res.message}`,                                                    width: '300px',
                                                    showConfirmButton: '#d33'
                                                });
                                            }
                                            }

                                        }
                                    })
                                    .catch(error => console.log(error))


                            }

                        }
                    }


                }

            }



            function handleRazorpayFailure(response, data) {

                console.log("response PaymentFailed orderId", response)//--------------------
                console.log("res.PaymentFailed orderId", data)//--------------------------
                let orderId = data.orderId
                console.log("orderId", orderId)//------------------------------------------

                fetch("/order/razorpay-failed", {
                    method: 'put',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ orderId })
                })
                    .then((response) => response.json())
                    .then((data) => {
                        console.log("data in razorpay failed resposnse", data)//----------------------------------

                        Swal.fire({
                            titleText: 'Something went wrong',
                            width: '300px',
                            padding: '10px',
                            icon: 'error',
                            showConfirmButton: false,
                            timer: 1500,
                        });
                        setTimeout(() => {
                            Swal.fire({
                            titleText: 'Payment Failed',
                            width: '300px',
                            padding: '10px',
                            icon: 'error',
                            showConfirmButton: false,
                            timer: 1500,
                        });
                        }, 500);

                        setTimeout(() => {
                            location.href = `/order-details?id=${data.orderDetails._id}`

                        }, 1600);
                    })
            }



            function verifyRazorpayPayment(payment, order) {
                console.log("within verifyRazorpayPayment in ejs**************************************************************")//-----------------------------
                console.log("response from vrify razorpayment", payment)//--------------------
                console.log("res.order_id verifyRazorpayPayment", order)//--------------------------

                let data = { payment, order }

                fetch("/order/verify-payment", {
                    method: 'Post',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                }).then((res) => res.json())
                    .then((res) => {

                        if (res.paymentSuccess) {

                            console.log("payment verification successs in ==============_---------------+=======================_____________________________________________")
                            location.href = `/order-success/${res.orderId}`
                        } else {
                            Swal.fire({
                                position: "center",
                                icon: "error",
                                title: "Payment failed",
                                showConfirmButton: false,
                                timer: 10500,
                            });
                        }
                    })
            }

            const applyCouponButton = document.getElementById('apply-coupon');

            applyCouponButton.addEventListener('click', applyCoupon);

                applyCouponButton.addEventListener('click', applyCoupon);
            


            // let removeCouponButton =document.getElementById('coupon-remove-button');

            const subTotalElement = document.getElementById('sub-total');
            let subTotalValue = subTotalElement.dataset.subtotal;
            subTotalValue = Math.round(subTotalValue);
            console.log("subTotalValue", subTotalValue)//------------
            const cartId = document.getElementById('order').getAttribute('cartId')
            console.log("cartId", cartId)//------------------------
            
            function applyCoupon() {
                console.log("applyCoupon involked")//----------


                const regex = /^[A-Za-z]{1,4}-[A-Za-z0-9]{6}-\d{1,2}$/;
                let couponCode = document.getElementById('coupon-code').value

                if (!regex.test(couponCode)) {
                    Swal.fire({
                        position: "center",
                        icon: "error",
                        title: "Please enter a valid coupon code",
                        showConfirmButton: false,
                        width: "300px",
                        timer: 1500,
                    });
                } else {
                    let data = {
                        couponCode,
                        cartId: cartId,
                        subTotal: subTotalValue
                    }

                 

                    fetch('/apply-coupon', {
                        method: 'post',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                        .then((res) => res.json())
                        .then((response) => {

                            if (response.valid) {
                              

                                let placeOrderButton = document.getElementById('place-order').setAttribute('coupon-code', couponCode);


                                // removeCouponButton.classList.replace("d-none", "d-block");
                                $('#page-content').load(`/checkout?subtotal=${subTotalValue} #page-content`, null, function () {


                                    // document.getElementById("discountId").innerText = `₹${response.couponDiscount}.00`;
                                    // console.log()
                                    // document.getElementById('sub-total').innerText = `₹${response.subTotal - response.couponDiscount}.00`;
                                    // console.log("withi success apply coupon")//-------------------------------------
                                    Swal.fire({
                                        position: "center",
                                        icon: "success",
                                        title: `${response.message}`,
                                        showConfirmButton: false,
                                        width: "300px",
                                        timer: 1500,
                                    });

                                    attachListernerApplyCoupon()

                                })
                            }
                            if (!response.valid) {
                                Swal.fire({
                                    position: "center",
                                    icon: "error",
                                    title: `${response.message}`,
                                    showConfirmButton: false,
                                    width: "300px",
                                    timer: 1500,
                                });
                            }

                        })
                }

            }


            document.body.addEventListener('click', function (event) {
                if (event.target.id === 'coupon-remove-button') {
                    removeCoupon(); // Assuming removeCoupon is defined
                }
            });


            function removeCoupon() {
                let data = {
                    cartId: cartId,
                    subTotal: subTotalValue,
                }
                console.log('remove coupon invoked')//------------------------

                fetch('/remove-coupon', {
                    method: 'post',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                }).then((res) => res.json())
                    .then((response) => {
                        if (response.removed) {

                            let placeOrderButton = document.getElementById('place-order').setAttribute('coupon-code', "");


                            Swal.fire({
                                    position: "center",
                                    icon: "success",
                                    title: `${response.message}`,
                                    showConfirmButton: false,
                                    width: "300px",
                                    timer: 1500,
                                });

                                setTimeout(()=>{
                                    window.location.href=`/checkout?subtotal=${subTotalValue}`
                                },1500)

                        }
                    })
            }

        </script>



        <script>

            // Assuming the table has an ID or a class for easy selection
            var table = document.querySelector('#myTable'); // Change '#myTable' to the actual ID or class of your table

            table.addEventListener('click', function (event) {
                // Check if the clicked target is a coupon code button
                var target = event.target;
                if (target.classList.contains('coupon-code')) {
                    // Prevent the default action to avoid any unwanted behavior
                    event.preventDefault();
                    // Get the coupon code text
                    var couponCode = target.innerText.trim();
                    // Copy the coupon code to the clipboard
                    navigator.clipboard.writeText(couponCode)
                        .then(() => {
                            // alert('Coupon code copied to clipboard!');
                            Swal.fire({
                                icon: "success",
                                text: "Code copied.",
                                width: "300px",
                                timer: 1000,
                            });
                        })
                        .catch(err => {
                            console.error('Could not copy text: ', err);
                            alert('Failed to copy coupon code. Please try again.');
                        });
                }
            });

        </script>

        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
        <!-- Including Jquery -->
        <script src="user/assets/js/vendor/jquery-3.3.1.min.js"></script>
        <script src="user/assets/js/vendor/jquery.cookie.js"></script>
        <script src="user/assets/js/vendor/modernizr-3.6.0.min.js"></script>
        <script src="user/assets/js/vendor/wow.min.js"></script>
        <!-- Including Javascript -->
        <script src="user/assets/js/bootstrap.min.js"></script>
        <script src="user/assets/js/plugins.js"></script>
        <script src="user/assets/js/popper.min.js"></script>
        <script src="user/assets/js/lazysizes.js"></script>
        <script src="user/assets/js/main.js"></script>



        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        </div>
        </body>

        <!-- belle/cart-variant1.html   11 Nov 2019 12:44:32 GMT -->

        </html>