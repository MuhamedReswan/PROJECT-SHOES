

<%- include('../layout/user/header.ejs') -%>

    <div class="pageWrapper">
        <%-include('../partials/userNavbar')-%>

            <style>
                .product-labels .lbl {
                    font-size: 8px;
                }
            </style>

            <!--Body Content-->
            <div id="page-content">
                <!--Collection Banner-->
                <div class="collection-header">
                    <div class="collection-hero">
                        <div class="collection-hero__image"><img class="blur-up lazyload"
                                data-src="user/assets/images/cat-women1.jpg" src="user/assets/images/cat-women1.jpg"
                                alt="Women" title="Women" /></div>
                        <div class="collection-hero__title-wrapper">
                            <h1 class="collection-hero__title page-width">Shop Grid 4 Column</h1>
                        </div>
                    </div>
                </div>
                <!--End Collection Banner-->

                <div class="container" style="padding-top: 30px; " id="reload-container">
                    <div class="row">
                        <!--Sidebar-->
                        <div class="col-12 col-sm-12 col-md-3 col-lg-3 sidebar filterbar">
                            <div class="closeFilter d-block d-md-none d-lg-none"><i
                                    class="icon icon anm anm-times-l"></i></div>
                            <div class="sidebar_tags">

                                <!--Brand-->
                                <div class="sidebar_widget filterBox filter-widget">
                                    <div class="widget-title">
                                        <h2>Brands</h2>
                                    </div>
                                    <ul>
                                        <% if(categoryData){ %>
                                            <% categoryData.forEach((category,index)=>{ %>
                                                <li>
                                                    <input type="checkbox" class="category-input-filter"
                                                        value="<%= category._id %>" id="category<%=index%>">
                                                    <label for="check1"><span><span></span></span>
                                                        <%= category.name %>
                                                    </label>
                                                </li>
                                                <% }) %>
                                                    <%}%>
                                    </ul>
                                </div>
                                <!--End Brand-->

                                <div class="sidebar_widget filterBox filter-widget ">
                                    <div class="filters-toolbar__item">
                                        <h2>Sort</h2>

                                        <label for="SortBy" class="hidden">Sort</label>
                                        <select name="SortBy" id="SortBy"
                                            class="filters-toolbar__input filters-toolbar__input--sort sort">
                                            <option value="all" selected="selected">all</option>
                                            <option value="a-z">Alphabetically, A-Z</option>
                                            <option value="z-a">Alphabetically, Z-A</option>
                                            <option value="low-high">Price, low to high</option>
                                            <option value="high-low">Price, high to low</option>
                                        </select>
                                    </div>
                                </div>
                                <!--Price Filter-->
                                <div class="sidebar_widget filterBox filter-widget">
                                    <div class="widget-title">
                                        <h2>Price</h2>
                                    </div>
                                    <div id="slider-range"
                                        class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">
                                        <div class="ui-slider-range ui-widget-header ui-corner-all"></div>
                                        <span class="ui-slider-handle ui-state-default ui-corner-all"
                                            tabindex="0"></span>
                                        <span class="ui-slider-handle ui-state-default ui-corner-all"
                                            tabindex="0"></span>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <p class="no-margin"><input id="amount" type="text"></p>
                                        </div>
                                        <div class="col-6 text-right margin-25px-top">
                                            <button class="btn btn-secondary btn--small"
                                                id="filter-button">filter</button>
                                        </div>
                                    </div>
                                </div>
                                <!--End Price Filter-->


                            </div>
                        </div>
                        <!--End Sidebar-->
                        <!--Main Content-->
                        <div class="col-12 col-sm-12 col-md-9 col-lg-9 main-col" id="product-container">
                            <div class="productList">
                                <!--Toolbar-->
                                <button type="button" class="btn btn-filter d-block d-md-none d-lg-none"> Product
                                    Filters</button>
                                <div class="toolbar">
                                    <div class="filters-toolbar-wrapper">
                                        <div class="row align-items-center justify-content-around">
                                            <div
                                                class="col-auto text-center filters-toolbar__item filters-toolbar__item--count">
                                                <span id="showingCount" class="filters-toolbar__product-count">Showing:
                                                    <%=productData.length %>
                                                </span>
                                            </div>
                                            <div class="col-auto">
                                                <div class="input-group">
                                                    <div class="form-outline" data-mdb-input-init>
                                                        <input id="search-input" type="text" class="form-control"
                                                            placeholder="search" />
                                                    </div>
                                                    <button id="search-button" type="button" class="btn btn-primary">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                                <!--End Toolbar-->
                                <div class="grid-products grid--view-items" id="product-div">
                                    <% if(productData){ %>
<% let offerDiscountedPrice %>
                                        <div class="row product-details">
                                            <% productData.forEach((product,index )=>{ %>
                                               
                                            <%let offerPercentege %>
<%let categoryDiscount=product?.category?.appliedOffer?.discount %>
<%let productDiscount=product?.appliedOffer?.discount %>

                                            <%if(categoryDiscount){
                                                offerPercentege = categoryDiscount
                                                }%>

                                            <%if(productDiscount &&  productDiscount !== undefined ){
                                                                offerPercentege =  productDiscount}%>

<%if(categoryDiscount && productDiscount){
    offerPercentege =Math.max(categoryDiscount, productDiscount)
    }%>
                                                <div class="col-6 col-sm-6 col-md-4 col-lg-3 item">
                                                    <!-- start product image -->
                                                    <div class="product-image">
                                                        <!-- start product image -->
                                                        <a href="/single-product?id=<%= product.id %>">
                                                            <!-- image -->
                                                            <img class="primary blur-up lazyload" id="mainImg1"
                                                                data-src="user/assets/images/product-images/sharpedImages/<%= product.images[0] %> "
                                                                src="user/assets/images/product-images/sharpedImages/<%= product.images[0] %> "
                                                                alt="image" title="product" />
                                                            <!-- End image -->
                                                            <!-- Hover image -->
                                                            <img class="hover blur-up lazyload" id="mainImg2"
                                                                data-src="user/assets/images/product-images/sharpedImages/<%= product.images[1] %> "
                                                                src="user/assets/images/product-images/sharpedImages/<%= product.images[1] %> "
                                                                alt="image" title="product" />
                                                            <!-- End hover image -->

                                                            <%if(offerPercentege){%>
                                                                <%  offerDiscountedPrice = Math.round((product.offerPrice/100)*offerPercentege)%>
                                                                <%}%> 
                                                                
                                                            <% if(product.totalStock>0){%>
                                                               
<%if(offerPercentege){%>
  <div class="product-labels"><span class="lbl on-sale">
  <%=offerPercentege
  %>% OFF
   </span></div>
<%}%> 
   
                                                                <%}else{%>
                                                                    <div class="product-labels "><span
                                                                            class="lbl on-sale">out of stock</span>
                                                                    </div>
                                                                    <%}%>

                                                        </a>
                                                        <!-- end product image -->

                                                        <!-- Start product button -->
                                                        <a class="variants add"
                                                            href="/single-product?id=<%= product.id %>"><button
                                                                class="btn btn-addto-cart" type="submit">view
                                                                Details</button></a>
                                                        <div class="button-set">
                                                            <div class="wishlist-btn">
                                                                <a class="wishlist add-to-wishlist"
                                                                    id="wishlist<%= index%>" title="Add to Wishlist"
                                                                    onclick="addToWishlist('<%=product._id%>', 'wishlist<%= index%>')">
                                                                    <i class="icon anm anm-heart-l "></i>
                                                                </a>
                                                            </div>

                                                        </div>
                                                        <!-- end product button -->
                                                    </div>
                                                    <!-- end product image -->

                                                    <!--start product details -->
                                                    <div class="product-details text-center">
                                                        <!-- product name -->
                                                        <div class="product-name">
                                                            <a href="#">
                                                                <%= product.name %>
                                                            </a>
                                                        </div>
                                                        <div class="product-brand">
                                                            <a href="#">
                                                                <%= product.brand %>
                                                            </a>
                                                        </div>
                                                        <%if(offerPercentege){%>
                                                            <!-- product price -->
                                                        <div class="product-price">
                                                            <span class="old-price">
                                                                ₹ <%= product?.offerPrice %>
                                                            </span>
                                                            <span class="price">
                                                                ₹ <%= Math.round(product?.offerPrice-offerDiscountedPrice) %>
                                                            </span>
                                                        </div>
                                                        <!-- End product price -->
<%}else{%>
<div class="product-price">
                                                            <span class="price">
                                                                ₹ <%= product.offerPrice %>
                                                            </span>
                                                        </div>
<%}%>

                                                        <div class="product-review">
                                                            <i class="font-13 fa fa-star"></i>
                                                            <i class="font-13 fa fa-star"></i>
                                                            <i class="font-13 fa fa-star"></i>
                                                            <i class="font-13 fa fa-star-o"></i>
                                                            <i class="font-13 fa fa-star-o"></i>
                                                        </div>
                                                        <!-- Variant -->
                                                        <ul class="swatches">
                                                            <% for(i=0; i<4; i++){ %>
                                                                <a href="/single-product?id=<%= product.id %>">
                                                                    <li id="fourimg" class="swatch medium rounded"><img
                                                                            src="user/assets/images/product-images/sharpedImages/<%= product.images[i] %>"
                                                                            alt="image <%=i+1%>" /></li>
                                                                    <%}%>
                                                                </a>
                                                        </ul>
                                                        <!-- End Variant -->
                                                    </div>
                                                    <!-- End product details -->
                                                </div>
                                                <% }) %>
                                        </div>

                                        <%}else{%>
                                            <div class="row text-center">
                                                <h3>NO PRODUCTS AVAILABLE NOW</h3>
                                            </div>
                                            <%}%>
                                </div>
                            </div>
                            <%if(productData.length>0){%>
                            <div class="infinitpaginOuter" id="pagination-shop">
                                <div class="infinitpagin">
                                    <!-- <a href="#" class="btn loadMore">Load More</a> -->
                                    <ul>
                                        <li class="btn" id="previous-button" value="<%=previous%>"
                                            data-status="previous">
                                            < </li>
                                        <li class="btn text-white" id="current-page" value="<%=page%>"
                                            data-value="<%=page%>">
                                            <%=page%>
                                        </li>
                                        <li class="btn" id="next-button" value="<%=next%>" data-status="next">></li>
                                    </ul>
                                </div>
                                <%}%>
                            </div>
                        </div>
                        <!--End Main Content-->
                    </div>
                </div>
            </div>
            <!--End Body Content-->


            <!--Footer-->
            <%-include('../partials/userBodyFooter.ejs')-%>
                <!--End Footer-->

                <!--Scoll Top-->
                <span id="site-scroll"><i class="icon anm anm-angle-up-r"></i></span>
                <!--End Scoll Top-->



                <script>
                    const amount = document.getElementById('amount');
                    amount.addEventListener('change', (e) => {
                        console.log('called', e.target.value);//----------------
                    })

                    function addToWishlist(productId, id) {
                        console.log('im add to wishlist function');//--------------
                        let data = { productId: productId }
                        console.log('data', data)//-------------
                        $.ajax({
                            type: 'post',
                            url: '/add-to-wishlist',
                            contentType: 'application/json',
                            data: JSON.stringify(data),

                            success: (res) => {
                                if (res.removed) {
                                    swal.fire({
                                        title: 'Removed',
                                        icon: 'success',
                                        text: 'Removed from wishlist !',
                                        timer: 1000
                                    })
                                    removeColourText(id)
                                }
                                if (res.added) {

                                    swal.fire({
                                        title: 'Added',
                                        icon: 'success',
                                        text: 'successfully added to wishlist !',
                                        timer: 1000
                                    })
                                    addColourText(id)
                                }
                            },
                            error: (error) => {
                                console.log(error);
                            }
                        })
                    }

                    function addColourText(id) {
                        console.log('add')//------------
                        const button = document.getElementById(`${id}`);
                        button.classList.add('text-danger');
                        button.setAttribute('title', 'remove from wishlist')
                    }

                    function removeColourText(id) {
                        console.log('remove')//------------
                        const button = document.getElementById(`${id}`);
                        button.classList.remove('text-danger');
                        button.setAttribute('title', 'remove from wishlist');
                    }

                    let filterButton = document.getElementById('filter-button');
                    filterButton.addEventListener('click', () => {
                        shopFilter()
                    })

                    let previousButton = document.getElementById('previous-button')
                    previousButton.addEventListener('click', (e) => {
                        let status = e.target.getAttribute('data-status')
                        console.log('status', status)//--------------------------
                        shopFilter(status)
                    })

                    let nextButton = document.getElementById('next-button')
                    nextButton.addEventListener('click', (e) => {
                        let status = e.target.getAttribute('data-status')
                        console.log('status', status)//--------------------------
                        shopFilter(status)
                    })

                    let shopSearchInput = document.getElementById('search-input')
                    shopSearchInput.addEventListener('keyup', () => {
                        shopFilter()
                    })

                    function shopFilter(buttonStatus) {
                        console.log('shopFilter called')//---------------------
                        let sort = document.getElementById('SortBy').value;
                        let priceRange = document.getElementById('amount').value;
                        let currentPage = document.getElementById('current-page').getAttribute('data-value')
                        let currentPageData = document.getElementById('current-page')
                        let selectedCategory = Array.from(document.querySelectorAll('.category-input-filter:checked'))
                            .map(selected => selected.value);
                        let procuctDiv = document.getElementById('product-container');
                        let showingCountElement = document.getElementById('showingCount')
                        let productContainer = document.querySelector('.row.product-details')
                        let searchInputText = shopSearchInput.value

                        console.log('searchInputText', searchInputText)//----------
                        console.log('selectedCategory', selectedCategory)//----------
                        console.log('sort', sort)//----------
                        console.log('priceRange', priceRange)//----------
                        console.log('currentPage', currentPage)//----------
                        console.log('buttonStatus', buttonStatus)//-------------------------
                        console.log('buttonStatus', buttonStatus)//-------------------------

                        if (selectedCategory) {

                            fetch('/filter-shop', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    selectedCategory: selectedCategory,
                                    sortBy: sort,
                                    priceRange: priceRange,
                                    currentPage: currentPage,
                                    buttonStatus: buttonStatus,
                                    searchInputText: searchInputText
                                })
                            })
                                .then((response) => {
                                    console.log('im in response json ');//--------------
                                    return response.json();
                                })
                                .then(data => {
                                    
                                    console.log('im daata ');//------------
                                    console.log('res', data);//-------------
                                    console.log('data.countOfProducts', data.countOfProducts);//------
                                    console.log('productdata', data.filterdProduct);//----------------
                                    console.log('data.page', data.page);//----------------
                                    console.log('data.page', data.totalPage);//----------------
                                    let showCount = data.countOfProducts;
                                    if (data.filterdProduct.length > 0) {

let offerPercentege ,offerDiscountedPrice

                                        productContainer.innerHTML = ""; 
                                        let productHtml = "";
                                        data.filterdProduct.forEach((product, index) => {

                                            let categoryOff = product?.category?.appliedOffer?.discount 
                                            let productOff = product?.appliedOffer?.discount 

console.log(`categoryOff---${categoryOff},productOff${productOff}`)//------------------------------------------

 offerPercentege = (productOff === undefined && categoryOff === undefined) 
    ? undefined 
    : (productOff !== undefined && categoryOff !== undefined) 
    ? (productOff > categoryOff ? productOff : categoryOff) 
    : (productOff !== undefined ? productOff : categoryOff);

                                            console.log("offerPercentege",offerPercentege)//----------------------
                                            
                                            offerDiscountedPrice = Math.round((product.offerPrice / 100) * offerPercentege);

                                            productHtml += `<div class="col-6 col-sm-6 col-md-4 col-lg-3 item">


                <!-- start product image -->
                <div class="product-image">
                    <a href="/single-product?id=${product._id}">
                        <img class="primary blur-up lazyload" id="mainImg1"
                            data-src="user/assets/images/product-images/sharpedImages/${product.images[0]}"
                            src="user/assets/images/product-images/sharpedImages/${product.images[0]}"
                            alt="image" title="product" />
                        <img class="hover blur-up lazyload" id="mainImg2"
                            data-src="user/assets/images/product-images/sharpedImages/${product.images[1]}"
                            src="user/assets/images/product-images/sharpedImages/${product.images[1]}"
                            alt="image" title="product" />
                        ${product.totalStock > 0 ?
                        offerPercentege? 
                                                    `<div class="product-labels"><span class="lbl on-sale">
                                ${offerPercentege}% OFF
                            </span></div>` 
                            
                            :       `<div></div>` 
                            :

                                                    `<div class="product-labels "><span class="lbl on-sale">out of stock</span></div>`
                                                }
                    </a>
                    <!-- end product image -->
                    <!-- Start product button -->
                    <a class="variants add" href="/single-product?id=${product._id}">
                        <button class="btn btn-addto-cart" type="submit">view Details</button>
                    </a>
                    <div class="button-set">
                        <div class="wishlist-btn">
                            <a class="wishlist add-to-wishlist"
                                id="wishlist${index}" title="Add to Wishlist"
                                onclick="addToWishlist('${product._id}', 'wishlist${index}')">
                                <i class="icon anm anm-heart-l "></i>
                            </a>
                        </div>
                    </div>
                    <!-- end product button -->
                </div>
                <!-- end product image -->
                <!--start product details -->
                <div class="product-details text-center">
                    <div class="product-name">
                        <a href="#">${product.name}</a>
                    </div>
                    <div class="product-brand">
                        <a href="#">${product.brand}</a>
                    </div>
                    <div class="product-price">
                        ${offerDiscountedPrice ?
                    `<span class="old-price">₹ ${product.offerPrice}</span>
                        <span class="price">₹ ${Math.round(product.offerPrice-offerDiscountedPrice)}</span>`
                        :`<span class="price">₹ ${product.offerPrice}</span>`
                    }




                        
                    </div>
                    <div class="product-review">
                        <i class="font-13 fa fa-star"></i>
                        <i class="font-13 fa fa-star"></i>
                        <i class="font-13 fa fa-star"></i>
                        <i class="font-13 fa fa-star-o"></i>
                        <i class="font-13 fa fa-star-o"></i>
                    </div>
                    <ul class="swatches">
                        ${(() => {
                                                    let html = "";
                                                    for (let i = 0; i < 4; i++) {
                                                        html += `<a href="/single-product?id=${product.id}">
                                    <li id="fourimg${i}" class="swatch medium rounded">
                                        <img src="user/assets/images/product-images/sharpedImages/${product.images[i]}" alt="image ${i + 1}" />
                                    </li>
                                </a>`;
                                                    }
                                                    return html;
                                                })()}
                    </ul>
                </div>
                <!-- End product details -->
            </div>`;
                                        });

                                        productContainer.innerHTML = productHtml; 
                                        currentPageData.setAttribute('data-value', data.page)
                                        currentPageData.setAttribute('value', data.page)
                                        currentPageData.innerText = data.page
                                        showingCountElement.textContent = `Showing: ${showCount}`
                                        productContainer.classList.remove('d-flex' ,'justify-content-center','align-items-center');
                                        document.getElementById('pagination-shop').style.display='block'

                                    } else { 
                                        document.getElementById('pagination-shop').style.display='none'
                                        showingCountElement.textContent = `Showing: ${showCount}`
                                        productContainer.classList.add('d-flex' ,'justify-content-center','align-items-center')
                                        productContainer.innerHTML = '<div class="row text-center mt-5 "><h3>NO PRODUCTS AVAILABLE NOW</h3></div>'; // Display message for no products
                                    }
                                })
                                .catch((error) => {
                                    console.error('Error:', error);
                                })
                                .catch((error) => {
                                    console.error('Error:', error);
                                });
                        }
                    }




                </script>

                <!-- Including Jquery -->
                <script src="user/assets/js/vendor/jquery-3.3.1.min.js"></script>
                <script src="user/assets/js/vendor/jquery.cookie.js"></script>
                <script src="user/assets/js/vendor/modernizr-3.6.0.min.js"></script>
                <script src="user/assets/js/vendor/wow.min.js"></script>
                <!-- Including Javascript -->
                <script src="user/assets/js/bootstrap.min.js"></script>
                <script src="user/assets/js/plugins.js"></script>
                <script src="user/assets/js/popper.min.js"></script>
                <script src="user/assets/js/lazysizes.js"></script>
                <script src="user/assets/js/main.js"></script>

                <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    </div>

    <%- include('../layout/user/footer.ejs') -%>